

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>He Recovery PLC &mdash; IBEX Developer&#39;s Manual</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=e6a88b47" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="MAPS Vacuum System" href="MAPS-Vacuum-System.html" />
    <link rel="prev" title="PLCs" href="../PLCs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBEX Developer's Manual
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Editing-the-Wiki.html">Editing this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interfaces &amp; Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Client.html">IBEX GUI (Eclipse)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Script-Generator.html">Script Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Scripting.html">Scripting (Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web.html">Web Dashboard &amp; Chat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IBEX Server &amp; Systems</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../System-components.html">Backend System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../IOCs.html">EPICS IOCs &amp; Support Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Cells.html">Cells</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Choppers.html">Choppers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cryogenics.html">Cryogenics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAE-and-the-ICP.html">DAE (Data Acquisition Electronics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAQ.html">DAQ (NI cDAQ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fluxgates.html">Fluxgates &amp; Magnetometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Gas-And-Liquid-Handling-Systems.html">Gas and liquid handling systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging-Cameras.html">Imaging Cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Loading-Rigs.html">Loading rigs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Magnets.html">Magnets &amp; Large Power Supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors.html">Motors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors-Extensions.html">Motor Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Multimeters.html">Multimeters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Other.html">Other / Miscellaneous</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../PLCs.html">PLCs</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">He Recovery PLC</a></li>
<li class="toctree-l3"><a class="reference internal" href="MAPS-Vacuum-System.html">MAPS Vacuum System</a></li>
<li class="toctree-l3"><a class="reference internal" href="OPCUA.html">OPC UA</a></li>
<li class="toctree-l3"><a class="reference internal" href="Omron-FINS.html">Omron FINS</a></li>
<li class="toctree-l3"><a class="reference internal" href="RIKEN-PLC.html">RIKEN PLC</a></li>
<li class="toctree-l3"><a class="reference internal" href="SANS2D-vacuum-PLC.html">SANS2D Vacuum PLC</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schneider-PLC.html">Schneider PLC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Polarisers-and-Analysers.html">Polarisers &amp; Analysers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Distribution-Unit-%28PDU%29.html">Power distribution units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Supplies.html">Power supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Pressure-Monitors.html">Pressure monitors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reflectometry-IOC.html">Reflectometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Rheometers.html">Rheometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sample-Changers.html">Sample Changers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Signal-Generators.html">Signal Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temperature-Controllers.html">Temperature Controllers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Systems.html">Systems Administration &amp; Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Processes &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Providing-Support.html">Providing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Deployment.html">Releases &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Processes.html">Processes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBEX Developer's Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a></li>
          <li class="breadcrumb-item"><a href="../PLCs.html">PLCs</a></li>
      <li class="breadcrumb-item active">He Recovery PLC</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_developers_manual/blob/master/doc/specific_iocs/plcs/Helium-Recovery-PLC.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="he-recovery-plc">
<h1>He Recovery PLC<a class="headerlink" href="#he-recovery-plc" title="Link to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>The Helium Recovery PLC is a FINS PLC used for monitoring various parameters related to the helium gas recovery system. It contains data that will need to be stored in the database of the Helium Level Monitoring project. Therefore, we wrote an IOC for this PLC so that the data will then be read by a python server via Channel Access.</p>
<p>The manuals folder on the shares drive has a note with a link to the web page used by Cryogenics to monitor the helium gas recovery system. This displays the vast majority of values that are read by the IOC and was used to make sure the IOC reads data correctly. The values not displayed on the web page are specified in the memory map.</p>
<p>This PLC is also currently being used for <a class="reference external" href="https://github.com/ISISNeutronMuon/HLM_PV_Import">HLM PV Import</a>.</p>
</section>
<section id="connection">
<h2>Connection<a class="headerlink" href="#connection" title="Link to this heading"></a></h2>
<p>The Helium Recovery PLC communicates by using FINS over UDP, and is connected over Ethernet. However, you should use TCPNOHEAD when running tests in devsim. The FINS cmd should be similar to the example given <a class="reference internal" href="Omron-FINS.html#omron-fins-configuration"><span class="std std-ref">here</span></a>.</p>
<p>The IP address and node for this PLC are noted on the memory map spreadsheet in the shares drive, in Manuals &gt; OMRON_FINS_PLCs &gt; Helium recovery PLC.</p>
<section id="commands">
<h3>Commands<a class="headerlink" href="#commands" title="Link to this heading"></a></h3>
<p>The memory map of this PLC can be found in a spreadsheet in the shares drive, as mentioned above. Not all of the memory locations in the memory map can be read by the IOC, as not all are needed for the HLM project. The red cells indicate elements that are not needed, yellow cells indicate elements that might need to be added in the future when Cryogenics has more information, and clear cells are needed and have all been implemented.</p>
<p>The memory map details the name, memory address, data type, description and units for every thing of interest to the HLM project that it stores.</p>
<p>The command used by the IOC to read from the PLC is <code class="docutils literal notranslate"><span class="pre">0x0101</span></code> for Memory Area Read, and it reads from the DM Memory area, with code <code class="docutils literal notranslate"><span class="pre">0x82</span></code>. The PLC uses word designated memory addresses, so the third byte of the start address in the FINS command should always be 0.</p>
</section>
<section id="data-representation">
<h3>Data representation<a class="headerlink" href="#data-representation" title="Link to this heading"></a></h3>
<p>This PLC uses big endian notation. The word size is 16 bit, so on the memory map the INT and UINT data types take up 16 bits, and the DWORD data type uses 32 bits. The REAL data type also takes up two words, so 32 bits.</p>
<p>Because the IOC needs to read over 150 memory locations, and a lot of PVs would be identical, the IOC makes use of templates to achieve this. There are different templates for different types of record for different data types, and in the substitutions you assign a PV name, description, memory address and unit for each PV, based on the contents of the memory map. Some PVs are placed in the header template because they are unique or because a template for only 2 PVs is not worth it.</p>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<p>In order to run this IOC and talk to the Helium recovery PLC, you should have a <code class="docutils literal notranslate"><span class="pre">FINS_01.cmd</span></code> in the settings area with the contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Init and connect</span>
<span class="n">finsUDPInit</span><span class="p">(</span><span class="s2">&quot;PLC&quot;</span><span class="p">,</span> <span class="s2">&quot;$(PLC_IP)&quot;</span><span class="p">,</span> <span class="s2">&quot;UDP&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;$(PLC_NODE=)&quot;</span><span class="p">)</span>

<span class="c1">## Load our record instances</span>
<span class="n">dbLoadRecords</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{TOP}</span><span class="s2">/db/he-recovery.db&quot;</span><span class="p">,</span><span class="s2">&quot;P=$(MYPVPREFIX),Q=HA:HLM:&quot;</span><span class="p">)</span>

</pre></div>
</div>
<p>The PV domain name for this IOC is HA, with HLM as a sub domain. <code class="docutils literal notranslate"><span class="pre">$(MYPVPREFIX)</span></code> should be set to blank when this IOC runs on a production machine. This is to make it the same as central services which runs with a blank prefix because it runs IOCs in multiple domains. The decision for that is at point 17 <a class="reference internal" href="../../processes/Decision-Log.html"><span class="doc std std-doc">here</span></a>. When running for IOC tests, <code class="docutils literal notranslate"><span class="pre">$(MYPVPREFIX)</span></code> will be <code class="docutils literal notranslate"><span class="pre">TE:MACHINE_NAME</span></code>.</p>
<p>You also need to set the PLC_IP and PLC_NODE macros in the IBEX GUI.</p>
</section>
<section id="gotchas">
<h2>Gotchas<a class="headerlink" href="#gotchas" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>During testing when the IOC had all PVs implemented, it was discovered that it was very slow and each test took up to 40 seconds. This was because the emulator was slow due to 150+ requests each second. To fix this, for testing all PVs should be made passive by setting the <code class="docutils literal notranslate"><span class="pre">$(SCAN)</span></code> macro in the <code class="docutils literal notranslate"><span class="pre">dbLoadRecords</span></code> call, which will make the tests run quite fast. <code class="docutils literal notranslate"><span class="pre">$(SCAN)</span></code> is a global macro for the scan fields of every PV, except the heartbeat. For communicating with the real device, this macro should be set to 10 seconds. The heartbeat is an exception because in order to properly see it changing from 0 to 1 and back it needs to scan every 0.5 seconds.</p></li>
<li><p>The vast majority of the PVs reading 16 bit integers from the PLC are private. They are read by an associated calc record which divides the value by 10 and is supposed to be user facing. The reason is that the these values need to be real numbers with decimal place, but they are represented as scaled integers in order to save memory space and be stored in 16 bits only rather than 32 bits. There three exceptions to this: the heartbeat and two turbine speeds. This is because the turbine speeds are not real numbers, and the heartbeat can only be 0 or 1.</p></li>
<li><p>All of the PVs reading 16 bit integer values support negative values, except the heartbeat. Because negative integer support needs to be actively added as mentioned in <a class="reference internal" href="Omron-FINS.html#omron-fins-writing-ioc"><span class="std std-ref">Omron FINS</span></a>, but the heartbeat can only be 0 or 1 and thus has no need. For the same reason, each 16 bit PV is tested with positive and negative values in the IOC Test Framework, to make sure the IOC can read properly whatever the PLC might store.</p></li>
<li><p>Some mbbi records only have two possible values, and the reason they are not bi records is that the integers in the PLC for those values were 1 and 2, not 0 and 1.</p></li>
<li><p>There are two liquefier alarms in the memory map. They are 16 bit integers, where each bit represents one alarm. In the first alarm liquefier integer, the first bit is a spare, and in the second one the last 7 bits are spares. These two integers are read by two longin records, from which the values are read into two mbbi direct records. The mbbiDirect records could not properly read from hardware directly. For each individual alarm, there is a bi record that reads from the correct bit in one of the two mbbiDirect records, and it is these records that are user facing. The meaning of each bit is commented in the IOC header template, in the shares drive and on the HLM project Sharepoint.</p></li>
</ul>
</section>
<section id="ndahemon-fins-setup-notes-procserv-no-ibex">
<h2>NDAHEMON FINS setup notes (procServ, no IBEX)<a class="headerlink" href="#ndahemon-fins-setup-notes-procserv-no-ibex" title="Link to this heading"></a></h2>
<p>Steps taken to run FINS static build on NDAHEMON with procServ without the rest of IBEX:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Copied:

\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\ioc\master\FINS
\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\iocstartup
\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\tools
\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\utils_win32
\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\config_env.bat
\\isis\inst$\Kits$\CompGroup\ICP\EPICS\EPICS_STATIC_CLEAN_win7_x64\BUILD-1094\EPICS\config_env_base.bat
in C:\Instrument\Apps\EPICS

C:\Instrument\Settings\config\NDAHEMON\configurations\FINS
from NDW2123 (personal work desktop)

Copy libmysql.dll, mysqlcppconn.dll into C:\Instrument\Apps\EPICS\ioc\master\FINS\bin\windows-x64-static

Run config_env

Edit C:\Instrument\Apps\EPICS\iocstartup\preiocinit.cmd:
Comment out 
# asSetFilename(&quot;$(ACCESSSECURITY)/default.acf&quot;)
# asSetSubstitutions(&quot;P=$(MYPVPREFIX),ACF_IH1=$(ACF_IH1=localhost),ACF_IH2=$(ACF_IH2=localhost),ACF_IH3=$(ACF_IH3=localhost),ACF_IH4=$(ACF_IH4=localhost)&quot;)

Take C:\Instrument\Apps\EPICS\iocstartup\procserv.bat
Edit it by removing the other IOCs and 
commenting out 
REM --noautorestart --wait                    (from the %ICPTOOLS%\cygwin_bin\procServ.exe --logstamp... line)
REM set EPICS_CAS_INTF_ADDR_LIST=127.0.0.1


2021-01-06 10:50:37,936 35236:34060 caproto.bcast.search WARNING  PV TE:NDAHEMON:HA:HLM:IMPURE_HE_SUPPLY:PRESSURE with cid 15002 found on multiple servers. Accepted address is 130.246.49.117:5064. Also found on 127.0.0.1:5064
Remove the 127. address from EPICS CA ADDR LIST (duplicate PVs)
Don&#39;t run two IOCs talking at the same FINS PLC (Session IDs).
PLC replies back to the wrong IOC.
Solved by leaving only 130.246.51.255 as EPICS_CA_ADDR_LIST in the HLM Manager.


Scheduled task to start FINS IOC procServ on system Startup
HLM PV Import service startup type set to Automatic (Delayed)

To start the FINS IOC via procServ: C:\Instrument\Apps\EPICS\iocstartup\start_FINS_procserv.bat
</pre></div>
</div>
<section id="start-fins-procserv-bat">
<h3>start_FINS_procserv.bat<a class="headerlink" href="#start-fins-procserv-bat" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>@echo OFF
setlocal
REM
REM generated by build_ioc_startups.py - DO NOT EDIT DIRECTLY
REM

REM launches procserv in delayed start mode for all known IOCs
REM The IOCs are started via channel access calls to ProcServCtrl (see procservctrl.bat)
set CYGWIN=nodosfilewarning
set MYDIRPROCSV=%~dp0
set IOCSH_SHOWWIN=H
set EPICS_CAS_BEACON_ADDR_LIST=127.255.255.255
call %MYDIRPROCSV%..\config_env_base.bat
set IOCLOGROOT=%ICPVARDIR%/logs/ioc
set LOGTIME=%%Y%%m%%d
for /F &quot;usebackq&quot; %%I in (`cygpath %IOCLOGROOT%`) do SET IOCCYGLOGROOT=%%I


REM IOC FINS_01 from C:\Instrument\Apps\EPICS\ioc\master\FINS\iocBoot\iocFINS-IOC-01
%ICPTOOLS%\cygwin_bin\procServ.exe --logstamp --logfile=&quot;%IOCCYGLOGROOT%/FINS_01-%LOGTIME%.log&quot; --timefmt=&quot;%%Y-%%m-%%d %%H:%%M:%%S&quot; --restrict --ignore=&quot;^D^C&quot; --name=FINS_01 --pidfile=&quot;/cygdrive/c/windows/temp/EPICS_FINS_01.pid&quot; --logport=20132 --chdir=&quot;/cygdrive/c/Instrument/Apps/EPICS/ioc/master/FINS/iocBoot/iocFINS-IOC-01&quot; 20131 %ComSpec% /c runIOC.bat st.cmd

REM --noautorestart --wait
REM set EPICS_CAS_INTF_ADDR_LIST=127.0.0.1
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../PLCs.html" class="btn btn-neutral float-left" title="PLCs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MAPS-Vacuum-System.html" class="btn btn-neutral float-right" title="MAPS Vacuum System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 31, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>