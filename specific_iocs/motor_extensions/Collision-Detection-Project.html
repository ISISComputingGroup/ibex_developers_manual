

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collision Detection &mdash; IBEX Developer&#39;s Manual</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=e6a88b47" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Motor Coordinate Transformations" href="Creating-soft-motors-to-control-real-motors.html" />
    <link rel="prev" title="Bump Strips" href="Bump-Strip.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBEX Developer's Manual
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Editing-the-Wiki.html">Editing this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interfaces &amp; Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Client.html">IBEX GUI (Eclipse)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Script-Generator.html">Script Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Scripting.html">Scripting (Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web.html">Web Dashboard &amp; Chat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IBEX Server &amp; Systems</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../System-components.html">Backend System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../IOCs.html">EPICS IOCs &amp; Support Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Cells.html">Cells</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Choppers.html">Choppers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cryogenics.html">Cryogenics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAE-and-the-ICP.html">DAE (Data Acquisition Electronics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAQ.html">DAQ (NI cDAQ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Datastreaming.html">Data Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fluxgates.html">Fluxgates &amp; Magnetometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Gas-And-Liquid-Handling-Systems.html">Gas and liquid handling systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging-Cameras.html">Imaging Cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Loading-Rigs.html">Loading rigs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Magnets.html">Magnets &amp; Large Power Supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors.html">Motors</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../Motors-Extensions.html">Motor Extensions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ALF-Goniometer-Axes.html">ALF Goniometer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Axis.html">Axis</a></li>
<li class="toctree-l3"><a class="reference internal" href="Bump-Strip.html">Bump Strips</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Collision Detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="Creating-soft-motors-to-control-real-motors.html">Motor Coordinate Transformations</a></li>
<li class="toctree-l3"><a class="reference internal" href="Fermi-Chopper-Lifter.html">Fermi chopper lifter</a></li>
<li class="toctree-l3"><a class="reference internal" href="IMAT-Lens-Adjustment.html">IMAT Lens Adjustment</a></li>
<li class="toctree-l3"><a class="reference internal" href="Jaws.html">Jaws</a></li>
<li class="toctree-l3"><a class="reference internal" href="MARI-Sample-Changer.html">MARI Sample Changer</a></li>
<li class="toctree-l3"><a class="reference internal" href="MERLIN%2C-LET-and-WISH-Oscillating-radial-collimators.html">MERLIN, LET and WISH Oscillating Radial Collimators</a></li>
<li class="toctree-l3"><a class="reference internal" href="Motion-Set-points.html">Motion Set Points</a></li>
<li class="toctree-l3"><a class="reference internal" href="OSIRIS-analyser-towers.html">OSIRIS Analyser Towers</a></li>
<li class="toctree-l3"><a class="reference internal" href="Portable-Eulerian-Cradle.html">Portable Eulerian Cradle</a></li>
<li class="toctree-l3"><a class="reference internal" href="SANS2D-Front-Beam-Stop-inhibit-movement.html">SANS2D Front Beam Stop Inhibit</a></li>
<li class="toctree-l3"><a class="reference internal" href="SANS2D-apertures-and-guides.html">SANS2D Apertures and Guides</a></li>
<li class="toctree-l3"><a class="reference internal" href="SANS2D-vacuum-tank-collision-avoidance.html">SANS2D vacuum tank collision avoidance</a></li>
<li class="toctree-l3"><a class="reference internal" href="Sample-Changer-Support-Module.html">SANS Sample Changer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Tosca-sample-positioner.html">TOSCA sample positioner</a></li>
<li class="toctree-l3"><a class="reference internal" href="ZOOM-DMS.html">ZOOM Detector motion system</a></li>
<li class="toctree-l3"><a class="reference internal" href="ZOOM-PGC.html">ZOOM Polariser, Guide and Collimator</a></li>
<li class="toctree-l3"><a class="reference internal" href="ZOOM-sample-stack.html">ZOOM Sample Stack</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Multimeters.html">Multimeters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Other.html">Other / Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PLCs.html">PLCs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Polarisers-and-Analysers.html">Polarisers &amp; Analysers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Distribution-Unit-%28PDU%29.html">Power distribution units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Supplies.html">Power supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Pressure-Monitors.html">Pressure monitors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reflectometry-IOC.html">Reflectometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Rheometers.html">Rheometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sample-Changers.html">Sample Changers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Signal-Generators.html">Signal Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temperature-Controllers.html">Temperature Controllers</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Processes &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Providing-Support.html">Providing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Deployment.html">Releases &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Processes.html">Processes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBEX Developer's Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a></li>
          <li class="breadcrumb-item"><a href="../Motors-Extensions.html">Motor Extensions</a></li>
      <li class="breadcrumb-item active">Collision Detection</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_developers_manual/blob/master/doc/specific_iocs/motor_extensions/Collision-Detection-Project.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="collision-detection">
<h1>Collision Detection<a class="headerlink" href="#collision-detection" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The collision avoidance monitor was removed in <a class="reference external" href="https://github.com/ISISComputingGroup/EPICS-inst_servers/pull/400/files">this PR</a>.</p>
</div>
<hr class="docutils" />
<p>This project aims to develop a system for detecting collisions within the LARMOR instrument at STFC’s ISIS facility, using the IBEX control system.</p>
<section id="original-behaviour">
<h2>Original Behaviour<a class="headerlink" href="#original-behaviour" title="Link to this heading"></a></h2>
<p>Presently, experiments are executed using Genie Python scripts, which command the various axes of motion, as well as the DAE system and other instrument systems. Care must be taken to ensure that the motion axes are not allowed to collide with each other, or other parts of the instrument. This means that “soft” limits must be placed on each axis of motion, based on the equipment present on the instrument and determined by the instrument scientist.</p>
<p>There are certain instrument configurations and situations where setting these “soft” limits does not allow the full range of motion required, or where the limits on multiple axes become interdependent. In this case, it would be useful to re-calculate the “soft” limits dynamically, in order to improve equipment safety whilst also giving the scientists greater freedom.</p>
</section>
<section id="proposed-system">
<h2>Proposed System<a class="headerlink" href="#proposed-system" title="Link to this heading"></a></h2>
<p>This project aims to produce a system capable of:</p>
<ol class="arabic simple">
<li><p>Developing a method for describing the geometry &amp; motion of an instrument</p></li>
<li><p>Detecting collisions which have occurred, and stopping motion</p></li>
<li><p>Dynamically calculating the range of motion for each axis of motion and updating the “soft” limits for each axis</p></li>
<li><p>Detecting a collision that is likely to occur in the future, due to moving multiple axes</p></li>
</ol>
<p>The system must appear transparent to the instrument users, and to this end, should require minimal changes to experiment scripts.</p>
<p>The system will be prototyped using python, which is already used extensively as part of IBEX.</p>
<p>The system resides within the <a class="reference external" href="https://github.com/ISISComputingGroup/EPICS-inst_servers">EPICS-inst_servers</a> repository. Start/stop scripts are in the root, with the code under CollisionDetection.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<p>This project assumes a development environment with a configured IBEX installation.</p>
<p>The system has been developed in PyCharm. For development purposes, the environment variables from the standard EPICS <code class="docutils literal notranslate"><span class="pre">config_env.bat</span></code> and from <code class="docutils literal notranslate"><span class="pre">start_collision_detection_cmd.bat</span></code> should be set in the PyCharm run configuration, with the script target set to <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>The system interfaces with the IBEX server using EPICS via the Channel Access protocol. Genie python is used for simple setting and getting of PVs, and the python <code class="docutils literal notranslate"><span class="pre">ca</span></code> module is used to monitor changes in PVs.</p>
<p>For collision detection, the system uses the Open Dynamics Engine, through the python module <code class="docutils literal notranslate"><span class="pre">pyode</span></code>. A wheel for which is located at <a class="reference external" href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#ode">https://www.lfd.uci.edu/~gohlke/pythonlibs/#ode</a></p>
<p>The system also produces a visual rendering of the system, for diagnostic and development purposes. This uses <code class="docutils literal notranslate"><span class="pre">pygame</span></code> and the <code class="docutils literal notranslate"><span class="pre">pyopengl</span></code> bindings, and needs <code class="docutils literal notranslate"><span class="pre">glut.dll</span></code> and <code class="docutils literal notranslate"><span class="pre">glut32.dll</span></code>, which are included in the repository and can be found <a class="reference external" href="ftp://ftp.sgi.com/opengl/glut/glut3.html">here</a>.</p>
</section>
<section id="related-tickets">
<h2>Related tickets<a class="headerlink" href="#related-tickets" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/2936:">https://github.com/ISISComputingGroup/IBEX/issues/2936:</a> Code refactor and contains significant discussion about the role, scope, and future development of the system as of May 2018.</p></li>
<li><p><a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/3141:">https://github.com/ISISComputingGroup/IBEX/issues/3141:</a> Technical debt outstanding following the completion of #2936</p></li>
<li><p><a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/3126:">https://github.com/ISISComputingGroup/IBEX/issues/3126:</a> Required enhancement to allow configuration of the system to work with different instruments without hard coding.</p></li>
<li><p><a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/2040:">https://github.com/ISISComputingGroup/IBEX/issues/2040:</a> A list of suggested enhancements which have been moved to this wiki</p></li>
</ul>
</section>
<section id="instrument-configurations">
<h2>Instrument configurations<a class="headerlink" href="#instrument-configurations" title="Link to this heading"></a></h2>
<section id="zoom">
<h3>ZOOM<a class="headerlink" href="#zoom" title="Link to this heading"></a></h3>
<p>ZOOM is running the system to detect collisions on its detector and trolley axes (<code class="docutils literal notranslate"><span class="pre">MTR0501</span></code>, <code class="docutils literal notranslate"><span class="pre">MTR0507</span></code>). These move linearly along the same axis. The measurements were provided by Dominic Oram and are shown in the schematic in <a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/2936">ticket 2936</a>.</p>
<p>The system was deployed here in May 2018 with the intention of reducing the number of times the bump strips are triggered by the two components getting too close. Resetting the bump strips requires a manual reset, so catching it with the system beforehand reduces work for the instrument scientists. Motion control have stated that no damage will result from the system not stopping the motors.</p>
</section>
<section id="sans2d-tank">
<h3>SANS2D Tank<a class="headerlink" href="#sans2d-tank" title="Link to this heading"></a></h3>
<p>The system was reanalysed for the SANS2D tank (<a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/4587">https://github.com/ISISComputingGroup/IBEX/issues/4587</a>). The following issues were found that made it unsuitable for an immediate solution:</p>
<ul class="simple">
<li><p>By moving two objects towards each other you can get just within the above limits before it comes to a stop,  when inside these limits the CAM will halt all motion and not let you move the items apart again. <a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/5605">Ticket</a></p></li>
<li><p>When automatically setting limits the CAM is not intelligent enough to realise that an object is currently moving out of the way, this could be avoided by just not using automatically set limits</p></li>
</ul>
</section>
</section>
<section id="system-overview">
<h2>System Overview<a class="headerlink" href="#system-overview" title="Link to this heading"></a></h2>
<p>The system comprises four main parts:</p>
<ol class="arabic simple">
<li><p>Collision detector</p></li>
<li><p>Limit calculator</p></li>
<li><p>PV server</p></li>
<li><p>Graphic visualiser</p></li>
</ol>
<p>Additionally the instrument geometry configuration must be described, and is loaded in from <code class="docutils literal notranslate"><span class="pre">config.py</span></code>.</p>
<section id="a-note-on-dial-vs-user-coordinates">
<h3>A Note on Dial <em>vs</em> User Coordinates<a class="headerlink" href="#a-note-on-dial-vs-user-coordinates" title="Link to this heading"></a></h3>
<p>The system uses the <em>dial</em> versions of the readback and limit PVs (<code class="docutils literal notranslate"><span class="pre">DVAL</span></code>, <code class="docutils literal notranslate"><span class="pre">DRBV</span></code>, <code class="docutils literal notranslate"><span class="pre">DHLM</span></code>, <code class="docutils literal notranslate"><span class="pre">DLLM</span></code>) to protect the collision detection algorithm from changes in the user coordinate system. See <a class="reference external" href="https://www3.aps.anl.gov/bcda/synApps/motor/R6-9/motorRecord.html">EPICS Motor Record</a>.</p>
</section>
<section id="collision-detector">
<h3>Collision Detector<a class="headerlink" href="#collision-detector" title="Link to this heading"></a></h3>
<p>The collision detector is responsible for stopping motion if a collision occurs. The collision detector must be executed frequently, to stop collisions as promptly as possible. The collision detector runs in a separate thread, to allow it to operate independently to the main program, and provides a <code class="docutils literal notranslate"><span class="pre">CollisionDetector.collisions</span></code> list for interfacing with the rest of the program.</p>
<p>The system uses the <a class="reference external" href="http://www.ode.org/">Open Dynamics Engine (ODE)</a> to calculate whether any bodies have collided, using the function <code class="docutils literal notranslate"><span class="pre">collide</span></code>. A list of <code class="docutils literal notranslate"><span class="pre">GeomBox</span></code> objects are created, one for each body, each containing an <code class="docutils literal notranslate"><span class="pre">ode.GeomBox</span></code> object. The <code class="docutils literal notranslate"><span class="pre">ode.Collide</span></code> function is used to determine whether each pair of geometries has collided. The <code class="docutils literal notranslate"><span class="pre">config.ignore</span></code> list ensures that only the geometries of interest are analysed, reducing the computational load.</p>
<p>When a collision is detected, the system sends a <code class="docutils literal notranslate"><span class="pre">.STOP</span></code> message to each motor that is currently moving, using Genie python.</p>
</section>
<section id="limit-calculator">
<h3>Limit Calculator<a class="headerlink" href="#limit-calculator" title="Link to this heading"></a></h3>
<p>The system dynamically calculates limits by stepping each motor through its range of motion, and checking for collisions, using the <code class="docutils literal notranslate"><span class="pre">auto_seek_limits</span></code> function. This can be approached as a sequential search, where <code class="docutils literal notranslate"><span class="pre">collide</span></code> is evaluated at each step along the range of motion. Each direction is searched first with a coarse step, then with a fine step.</p>
<p>This works on the assumption that most collisions behave like a <a class="reference external" href="https://en.wikipedia.org/wiki/Rectangular_function">rectangular function</a>, and remain collided for a significant portion of movement. Typically this is true for linear motion, but when objects are inclined or in rotary cases the duration of the rectangle function is short. This means that for any step size, the search is not guaranteed to find collision.</p>
<p>If the geometries of the computer model are sufficiently larger than the real-world system, the search step can be optimised.</p>
<p>For a given increase in size <code class="docutils literal notranslate"><span class="pre">S</span></code> applied to each face of the box:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelled</span> <span class="n">size</span> <span class="o">=</span> <span class="n">actual</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="n">S</span>
</pre></div>
</div>
<p>Assuming a head on collision and considering only linear movement of the seeking axis, a collision of the real world system occurs once the model has collided by at least <code class="docutils literal notranslate"><span class="pre">2S</span></code>. Furthermore, taking two objects with an actual size of zero, and a modelled size of <code class="docutils literal notranslate"><span class="pre">2S</span></code>, a “head-on” collision is maintained for <code class="docutils literal notranslate"><span class="pre">4S</span></code>.</p>
<p><img alt="Head on" src="../../_images/Oversize.PNG" /></p>
<p>In the case of an inclined collision, the collision will persist for longer as the collision path through the centre of the object increases with angle.</p>
<p><img alt="Inclined" src="../../_images/Inclined.PNG" /></p>
<p>In the case of a glancing collision, whereby the collision of the model does not infer a collision of the real world system, a collision of the model may or may not be detected, but the real-world system will never be at risk.
Therefore any search step of <code class="docutils literal notranslate"><span class="pre">4S</span></code> or less will detect a real-world collision.</p>
<p><img alt="Grazing" src="../../_images/Grazing.PNG" /></p>
<p>For movements which involve rotation however, the search step must be chosen to ensure that no point on the body moves by more than <code class="docutils literal notranslate"><span class="pre">4S</span></code> in any direction. To achieve this, the system calculates the positions of each vertex of the body at each step. The magnitude of the move is calculated, and if greater than <code class="docutils literal notranslate"><span class="pre">4S</span></code>, the search step can be reduced. The magnitude of the move is re-calculated and the step reduced until the step is less than or equal to <code class="docutils literal notranslate"><span class="pre">4S</span></code>.</p>
<p>Once an appropriate step size has been found, the magnitude of the move need not be calculated further, reducing the computational load. This assumes that the movement of any body can be expressed as a linear function of the seeking axis - each subsequent step in the seeking process produces a movement of magnitude equal to the first step.</p>
<p>###PV Server</p>
<p>The system exposes some PVs for controlling operation, and getting feedback for the user through <code class="docutils literal notranslate"><span class="pre">pv_server.py</span></code>. The <a class="reference external" href="https://pcaspy.readthedocs.io/en/latest/tutorial.html">pcaspy</a> module is used to achieve this, similarly to the BlockServer.</p>
<p>There is no access security in the EPICS sense. However, writing to read only PVs is ignored by the driver.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>PV Name</p></th>
<th class="head text-left"><p>Access</p></th>
<th class="head text-left"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_LIMIT</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>Automatically send new limits to all motors whenever new dynamic limits are calculated. If 0, the limits from <code class="docutils literal notranslate"><span class="pre">config.py</span></code> are sent instead. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_STOP</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>Automatically issue a <code class="docutils literal notranslate"><span class="pre">.STOP</span></code> command to any moving motors, when a collision is detected. If 0, no <code class="docutils literal notranslate"><span class="pre">.STOP</span></code> commands will be sent. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">CALC</span></code></p></td>
<td class="text-left"><p>W</p></td>
<td class="text-left"><p>Writing any number to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">COARSE</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>The initial coarse step used when seeking limits. <code class="docutils literal notranslate"><span class="pre">OVERSIZE</span></code> is also updated so that the relationship <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">OVERSIZE</span> <span class="pre">=</span> <span class="pre">COARSE</span></code> is maintained. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">COLLIDED</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of values for each body. Value will be 1 is a collision has been detected on that body.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">FINE</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>The fine step used when seeking limits. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">HI_LIM</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the upper dynamic limits for each motor axis.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">LO_LIM</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the lower dynamic limits for each motor axis.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">MODE</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>A 3-bit binary number of the operating mode (see <code class="docutils literal notranslate"><span class="pre">OperatingMode</span></code> class): bit 0 = <code class="docutils literal notranslate"><span class="pre">AUTO_STOP</span></code>, bit 1 = <code class="docutils literal notranslate"><span class="pre">AUTO_LIMIT</span></code>, bit 2 = close the program. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">MSG</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A human readable message describing the current collision status. This <em>could</em> be added to the spangle banner. Typical messages include <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">collisions</span> <span class="pre">detected.</span></code>, <code class="docutils literal notranslate"><span class="pre">Collision</span> <span class="pre">expected</span> <span class="pre">in</span> <span class="pre">0.9s</span> <span class="pre">-</span> <span class="pre">1.0s</span></code>, <code class="docutils literal notranslate"><span class="pre">Collision</span> <span class="pre">on</span> <span class="pre">Name1,</span> <span class="pre">Name2</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">NAMES</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the names read from <code class="docutils literal notranslate"><span class="pre">config.py</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">OVERSIZE</span></code></p></td>
<td class="text-left"><p>R/W</p></td>
<td class="text-left"><p>The additional distance added to the faces of each bodies, to make collisions easier to detect. <code class="docutils literal notranslate"><span class="pre">COARSE</span></code> is also updated so that the relationship <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">OVERSIZE</span> <span class="pre">=</span> <span class="pre">COARSE</span></code> is maintained. Writing to this PV will cause the dynamic limits to be recalculated.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">RAND</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A random number for testing that the server is responsive</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">SAFE</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>Value is 0 if any collisions have occurred, otherwise 1.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">TIME</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>The time taken to calculate the last set of dynamic limits</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">TRAV_F</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the distance from the current position to the upper limit for each motor axis.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">TRAV_R</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the distance from the current position to the lower limit for each motor axis. Should always be a negative number.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">TRAVEL</span></code></p></td>
<td class="text-left"><p>R</p></td>
<td class="text-left"><p>A list of the distance to the closest dynamic limit for each motor axis. If the axis is at either of its limits, this will be 0.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="graphic-visualiser">
<h3>Graphic Visualiser<a class="headerlink" href="#graphic-visualiser" title="Link to this heading"></a></h3>
<p>The visualiser is started with the main program, and can be found in <code class="docutils literal notranslate"><span class="pre">render.py</span></code>.</p>
<p>The visualiser runs in its own thread, and iterates every 50 ms to draw each frame. It updates the graphic by monitoring the <code class="docutils literal notranslate"><span class="pre">.DRBV</span></code> PVs of each axis, and through a <code class="docutils literal notranslate"><span class="pre">RenderParams</span></code> object containing the soft limits, the collision status, and the duration of the most recent limit calculation.</p>
<p><img alt="Screenshot" src="../../_images/ScreenShot.png" /></p>
<section id="keyboard-controls">
<h4>Keyboard Controls<a class="headerlink" href="#keyboard-controls" title="Link to this heading"></a></h4>
<p>The program can be controlled through the visualisation window in the same way as setting the <code class="docutils literal notranslate"><span class="pre">MODE</span></code> PV.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>Key</p></th>
<th class="head text-left"><p>Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>1</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_STOP</span></code> on.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>2</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_STOP</span></code> off.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>3</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_LIMIT</span></code> on.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>4</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">AUTO_LIMIT</span></code> off.</p></td>
</tr>
</tbody>
</table>
<p>The camera can also be re-positioned within the visualisation:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>Key</p></th>
<th class="head text-left"><p>Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>W</p></td>
<td class="text-left"><p>Forward</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>A</p></td>
<td class="text-left"><p>Strafe left</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>S</p></td>
<td class="text-left"><p>Backward</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>D</p></td>
<td class="text-left"><p>Strafe right</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Q</p></td>
<td class="text-left"><p>Down</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>E</p></td>
<td class="text-left"><p>Up</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Z</p></td>
<td class="text-left"><p>Rotate clockwise</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>X</p></td>
<td class="text-left"><p>Rotate anti-clockwise</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Up</p></td>
<td class="text-left"><p>Pan up</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Down</p></td>
<td class="text-left"><p>Pan down</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Left</p></td>
<td class="text-left"><p>Pan left</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Right</p></td>
<td class="text-left"><p>Pan right</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Space</p></td>
<td class="text-left"><p>Reset to initial view</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="describing-instrument-geometry">
<h3>Describing Instrument Geometry<a class="headerlink" href="#describing-instrument-geometry" title="Link to this heading"></a></h3>
<p>The geometry of the instrument is described in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>. Generally the content of this file is a set of parameter lists, indexed against either the bodies in the mechanical system, or the motion axes. The various parameters are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>Parameter</p></th>
<th class="head text-left"><p>Indexed on</p></th>
<th class="head text-left"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">colors</span></code></p></td>
<td class="text-left"><p>Axis</p></td>
<td class="text-left"><p>A list of RGB tuples used when drawing the limits and current position of each axis, where <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1,</span> <span class="pre">1)</span></code> is white. The colours can be re-used in <code class="docutils literal notranslate"><span class="pre">geometries</span></code>. Red <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">0,</span> <span class="pre">0)</span></code> ought not be used as bodies are drawn in red if they have collided.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">geometries</span></code></p></td>
<td class="text-left"><p>Body</p></td>
<td class="text-left"><p>A list of <code class="docutils literal notranslate"><span class="pre">dict</span></code> containing the <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">size</span></code>, and optionally <code class="docutils literal notranslate"><span class="pre">color</span></code>, and <code class="docutils literal notranslate"><span class="pre">position</span></code> parameters of the body. For moving bodies, the <code class="docutils literal notranslate"><span class="pre">position</span></code> is not required, as it will be overridden whenever the system moves. The <code class="docutils literal notranslate"><span class="pre">color</span></code> defaults to white.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">moves</span></code></p></td>
<td class="text-left"><p>Body</p></td>
<td class="text-left"><p>A list of functions which take a list of position values, and return a <code class="docutils literal notranslate"><span class="pre">Transformation</span></code> to describe the new position of each mechanical body. Alternatively (and more efficiently) a function which moves everything and yields <code class="docutils literal notranslate"><span class="pre">Transformation</span></code>s at each step, which can then be iterated over in the same way as the list.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">pvs</span></code></p></td>
<td class="text-left"><p>Axis</p></td>
<td class="text-left"><p>A list of motor PVs for each axis. The order of these PVs is the order of the position values given to <code class="docutils literal notranslate"><span class="pre">moves</span></code>.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">hardlimits</span></code></p></td>
<td class="text-left"><p>Axis</p></td>
<td class="text-left"><p>The end limits of each axis of motion. Nominally the end of travel, though tighter limits can be imposed. The dynamically calculated limits are always within these values.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">ignore</span></code></p></td>
<td class="text-left"><p>N/A</p></td>
<td class="text-left"><p>A list of <code class="docutils literal notranslate"><span class="pre">geometries</span></code> index pairs which are not of interest. This is useful for bodies which are mechanically connected - we don’t care if the carriage collides with it’s slide. As this list can be long for a complicated moving system, this is best generated using a nested <code class="docutils literal notranslate"><span class="pre">for</span></code> loop.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">coarse</span></code></p></td>
<td class="text-left"><p>N/A</p></td>
<td class="text-left"><p>The initial coarse limit seek step, which can be overridden by PV.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">fine</span></code></p></td>
<td class="text-left"><p>N/A</p></td>
<td class="text-left"><p>The initial fine limit seek step, which can be overridden by PV (but probably never needs to change from 0.5).</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">oversize</span></code></p></td>
<td class="text-left"><p>N/A</p></td>
<td class="text-left"><p>The initial oversize parameter to apply to the bodies, which can be overridden by PV. The relationship <code class="docutils literal notranslate"><span class="pre">oversize</span> <span class="pre">=</span> <span class="pre">coarse</span> <span class="pre">/</span> <span class="pre">4</span></code> should be maintained.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="suggested-enhancements">
<h2>Suggested enhancements<a class="headerlink" href="#suggested-enhancements" title="Link to this heading"></a></h2>
<p>Originally taken from <a class="reference external" href="https://github.com/ISISComputingGroup/IBEX/issues/2040">https://github.com/ISISComputingGroup/IBEX/issues/2040</a></p>
<ul class="simple">
<li><p>[ ]  Change the <code class="docutils literal notranslate"><span class="pre">config.ignore</span></code> list to a “collisions of interest” list to make it shorter and easier to write out - but the default would be to ignore that body completely if <code class="docutils literal notranslate"><span class="pre">config.py</span></code> was wrong</p></li>
<li><p>[x]  Add some diagrams to the “Limit Calculator” section of the Wiki page.</p></li>
<li><p>[ ]  Find out if the <code class="docutils literal notranslate"><span class="pre">TRAVEL</span></code> PV will ever be useful to anyone.</p></li>
<li><p>[ ]  Make the collision detection thread talk to the visualiser thread for updating the collision status of bodies (making them turn red more promptly).</p></li>
<li><p>[ ]  Remove <code class="docutils literal notranslate"><span class="pre">config.oversize</span></code>, and calculate the correct value for oversize in <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p></li>
<li><p>[ ]  Remove <code class="docutils literal notranslate"><span class="pre">config.control_pv</span></code> as it shouldn’t need to change based on the instrument’s configuration (see *).</p></li>
<li><p>[ ]  * Make the program aware of its current instrument context - load the current PV from the environment variables at startup, and work out the full motor/control PVs appropriately.</p></li>
<li><p>[ ]  Load the configuration from an appropriate location based on the instrument configuration (ask the BlockServer)</p></li>
<li><p>[ ]  Calculate the oversize of the models based on the stopping distances of the motors in the system</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Bump-Strip.html" class="btn btn-neutral float-left" title="Bump Strips" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Creating-soft-motors-to-control-real-motors.html" class="btn btn-neutral float-right" title="Motor Coordinate Transformations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Feb 27, 2026.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>