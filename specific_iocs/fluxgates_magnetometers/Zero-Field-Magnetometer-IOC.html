

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zero-field Magnetometer (NI cDAQ) &mdash; IBEX Developer&#39;s Manual</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=e6a88b47" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Gas and liquid handling systems" href="../Gas-And-Liquid-Handling-Systems.html" />
    <link rel="prev" title="Metrolab PT2025 Teslameter" href="Metrolab-PT2025-Teslameter-IOC.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBEX Developer's Manual
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Editing-the-Wiki.html">Editing this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interfaces &amp; Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Client.html">IBEX GUI (Eclipse)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Script-Generator.html">Script Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Scripting.html">Scripting (Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web.html">Web Dashboard &amp; Chat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IBEX Server &amp; Systems</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../System-components.html">Backend System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../IOCs.html">EPICS IOCs &amp; Support Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Cells.html">Cells</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Choppers.html">Choppers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cryogenics.html">Cryogenics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAE-and-the-ICP.html">DAE (Data Acquisition Electronics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DAQ.html">DAQ (NI cDAQ)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../Fluxgates.html">Fluxgates &amp; Magnetometers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Bartington.html">Bartington</a></li>
<li class="toctree-l3"><a class="reference internal" href="Group3-Hall-Probe.html">Group3 Hall Probe</a></li>
<li class="toctree-l3"><a class="reference internal" href="Metrolab-PT2025-Teslameter-IOC.html">Metrolab PT2025 Teslameter</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Zero-field Magnetometer (NI cDAQ)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Gas-And-Liquid-Handling-Systems.html">Gas and liquid handling systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging-Cameras.html">Imaging Cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Loading-Rigs.html">Loading rigs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Magnets.html">Magnets &amp; Large Power Supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors.html">Motors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors-Extensions.html">Motor Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Multimeters.html">Multimeters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Other.html">Other / Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PLCs.html">PLCs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Polarisers-and-Analysers.html">Polarisers &amp; Analysers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Distribution-Unit-%28PDU%29.html">Power distribution units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Supplies.html">Power supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Pressure-Monitors.html">Pressure monitors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reflectometry-IOC.html">Reflectometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Rheometers.html">Rheometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sample-Changers.html">Sample Changers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Signal-Generators.html">Signal Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temperature-Controllers.html">Temperature Controllers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Systems.html">Systems Administration &amp; Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Processes &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Providing-Support.html">Providing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Deployment.html">Releases &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Processes.html">Processes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBEX Developer's Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a></li>
          <li class="breadcrumb-item"><a href="../Fluxgates.html">Fluxgates &amp; Magnetometers</a></li>
      <li class="breadcrumb-item active">Zero-field Magnetometer (NI cDAQ)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_developers_manual/blob/master/doc/specific_iocs/fluxgates_magnetometers/Zero-Field-Magnetometer-IOC.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="zero-field-magnetometer-ni-cdaq">
<h1>Zero-field Magnetometer (NI cDAQ)<a class="headerlink" href="#zero-field-magnetometer-ni-cdaq" title="Link to this heading"></a></h1>
<section id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Link to this heading"></a></h2>
<p>The magnetometer reads magnetic field strengths from the beamline. This IOC takes the magnetometer signal, applies corrections and performs a check to make sure that the magnetometer has not been overloaded.</p>
<p>This IOC is designed to be used in conjunction with a sequencer IOC, which uses the field values to calculate corrections needed to maintain a magnetic field strength. When a new field value is required, the sequencer will process the <code class="docutils literal notranslate"><span class="pre">$(P)TAKEDATA</span></code> PV of this IOC. When the new field values are available, this IOC processes <code class="docutils literal notranslate"><span class="pre">$(PVPREFIX):ZFCNTRL_01:INPUTS_UPDATED.PROC</span></code>, which it expects to allow the sequencer IOC to continue its calculations. This PV can be changed by setting the <code class="docutils literal notranslate"><span class="pre">$(SQNCR)</span></code> macro.</p>
</section>
<section id="corrections-applied-to-the-input-fields">
<h2>Corrections applied to the input fields<a class="headerlink" href="#corrections-applied-to-the-input-fields" title="Link to this heading"></a></h2>
<p>The maths which defines these operations is described in finer detail <a class="reference internal" href="../magnets/Zero-field-controller.html"><span class="doc std std-doc">here</span></a>.</p>
<ol class="arabic simple">
<li><p>Magnetometer range scaling</p>
<ul class="simple">
<li><p>The three field components are multiplied by a scaling factor to transform the input on to the range of the magnetometer. The scaling factor is set by the macro <code class="docutils literal notranslate"><span class="pre">$(RANGE)</span></code>, and is held in the PV <code class="docutils literal notranslate"><span class="pre">$(P)RANGE</span></code>.</p></li>
</ul>
</li>
<li><p>Applying offsets</p>
<ul class="simple">
<li><p>Each component has a unique offset which is subtracted from the scaled data. These offsets are set as the macros <code class="docutils literal notranslate"><span class="pre">$(OFFSETX),</span> <span class="pre">$(OFFSETY),</span> <span class="pre">$(OFFSETZ)</span></code>. These can also be set by the PVs <code class="docutils literal notranslate"><span class="pre">$(P):X:OFFSET</span></code> and from the OPI.</p></li>
</ul>
</li>
<li><p>Multiply with sensor matrix</p>
<ul class="simple">
<li><p>To obtain the corrected field strengths, the scaled and offset values need to be multiplied by a ‘field sensor’ matrix.</p></li>
<li><p>Macros define the sensor matrix: <code class="docutils literal notranslate"><span class="pre">$(MATRIX_X_Y)</span></code>, where X and Y are the row and column indices.</p></li>
<li><p>PVs hold the elements of the sensor matrix: <code class="docutils literal notranslate"><span class="pre">$(P)SENSORMATRIX:XY</span></code>. These PVs can also be changed on the OPI.</p></li>
<li><p>The multiplication itself is done as an aSub record. This allows us to use the libraries available to us through GSL.</p></li>
<li><p>Set up using GSL vector and matrix structures, performing the matrix multiplication is a relatively straightforward call to a vector/matrix multiplication BLAS routine in GSL.</p></li>
<li><p>The documentation for GSL data structures used is <a class="reference external" href="https://www.gnu.org/software/gsl/doc/html/vectors.html">here</a>.</p></li>
<li><p>The GSL documentation for BLAS routines is lacking (see <a class="reference external" href="https://www.gnu.org/software/gsl/doc/html/blas.html">documentation</a>). To get more in-depth information about the arguments used I would look up the routine in the <a class="reference external" href="http://www.netlib.org/blas/">BLAS documentation</a>.</p></li>
</ul>
</li>
<li><p>Output</p>
<ul class="simple">
<li><p>The corrected field strengths are written directly to the PVs <code class="docutils literal notranslate"><span class="pre">$(P)X:CORRECTEDFIELD</span></code> from the aSub record.</p></li>
<li><p>The aSub record also calculates the magnitude of the corrected field and places it in <code class="docutils literal notranslate"><span class="pre">$(P)FIELDSTRENGTH</span></code>.</p></li>
</ul>
</li>
</ol>
</section>
<section id="overload">
<h2>Overload<a class="headerlink" href="#overload" title="Link to this heading"></a></h2>
<p>High field values will overload the magnetometer, which is detected in this IOC. The overload condition for the EMU magnetometer is:</p>
<p><code class="docutils literal notranslate"><span class="pre">max(measured_field)</span> <span class="pre">&gt;</span> <span class="pre">magnetometer_range</span> <span class="pre">*</span> <span class="pre">4.5</span></code></p>
<p>Where:</p>
<ul class="simple">
<li><p>max(measured_field) is the largest component of the 3 scaled (but not offset or matrix multiplied) input field strengths.</p></li>
<li><p>magnetometer_range is the scaling factor used in the magnetometer range scaling</p></li>
<li><p>4.5 is a constant taken from the EMU VI. This value may be different for other magnetometers.</p></li>
</ul>
</section>
<section id="process-order">
<h2>Process order<a class="headerlink" href="#process-order" title="Link to this heading"></a></h2>
<p>A requirement of this IOC is to maintain as consistent a time as possible between measuring the data and performing calculations using it. To achieve this, no records in this IOC scan. Instead, each record forward links to the next record to be processed in order. This is outlined below:</p>
<p><code class="docutils literal notranslate"><span class="pre">TAKEDATA</span></code> is processed at regular intervals by the sequencer which is running in the <code class="docutils literal notranslate"><span class="pre">ZFCNTRL_01</span></code> ioc.</p>
<p><img alt="" src="../../_images/magnetometer_daq.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Metrolab-PT2025-Teslameter-IOC.html" class="btn btn-neutral float-left" title="Metrolab PT2025 Teslameter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Gas-And-Liquid-Handling-Systems.html" class="btn btn-neutral float-right" title="Gas and liquid handling systems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 31, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>