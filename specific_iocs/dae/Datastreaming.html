

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datastreaming &mdash; IBEX Developer&#39;s Manual</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=e6a88b47" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="File writing" href="datastreaming/Datastreaming---File-writing.html" />
    <link rel="prev" title="Dae Spectra Updating Problem" href="Dae-Spectra-Updating-Problem.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBEX Developer's Manual
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Editing-the-Wiki.html">Editing this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interfaces &amp; Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Client.html">IBEX GUI (Eclipse)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Script-Generator.html">Script Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Scripting.html">Scripting (Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web.html">Web Dashboard &amp; Chat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IBEX Server &amp; Systems</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../System-components.html">Backend System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../IOCs.html">EPICS IOCs &amp; Support Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Cells.html">Cells</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Choppers.html">Choppers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cryogenics.html">Cryogenics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../DAE-and-the-ICP.html">DAE (Data Acquisition Electronics)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="DAE-Live-View.html">Live View</a></li>
<li class="toctree-l3"><a class="reference internal" href="DAE-Normal-Log.html"><code class="docutils literal notranslate"><span class="pre">isisicp</span></code> Standard startup log</a></li>
<li class="toctree-l3"><a class="reference internal" href="DAE-PVs.html">DAE Spectra</a></li>
<li class="toctree-l3"><a class="reference internal" href="DAE-Pre-and-Post-commands.html">DAE Pre &amp; Post commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="DAE-Trouble-Shooting.html">DAE Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="Dae-Spectra-Updating-Problem.html">Dae Spectra Updating Problem</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Datastreaming</a><ul>
<li class="toctree-l4"><a class="reference internal" href="datastreaming/Datastreaming---File-writing.html">File writing</a></li>
<li class="toctree-l4"><a class="reference internal" href="datastreaming/Datastreaming---Sample-Environment.html">Sample environment forwarding</a></li>
<li class="toctree-l4"><a class="reference internal" href="datastreaming/Datastreaming-How-To.html">Data streaming how-to guide</a></li>
<li class="toctree-l4"><a class="reference internal" href="datastreaming/Datastreaming-Topics.html">Data streaming topics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Experimental-Runs.html">Experimental Run Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="ISISICP---enabling-incremental-event-file-creation.html">ISISICP - enabling incremental event file creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Shrinking-ISISICP-Memory-Usage-on-Simulated-DAE-machines.html">Reducing <code class="docutils literal notranslate"><span class="pre">ISISICP</span></code> memory use in simulation mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DAQ.html">DAQ (NI cDAQ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fluxgates.html">Fluxgates &amp; Magnetometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Gas-And-Liquid-Handling-Systems.html">Gas and liquid handling systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging-Cameras.html">Imaging Cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Loading-Rigs.html">Loading rigs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Magnets.html">Magnets &amp; Large Power Supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors.html">Motors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Motors-Extensions.html">Motor Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Multimeters.html">Multimeters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Other.html">Other / Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PLCs.html">PLCs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Polarisers-and-Analysers.html">Polarisers &amp; Analysers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Distribution-Unit-%28PDU%29.html">Power distribution units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Power-Supplies.html">Power supplies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Pressure-Monitors.html">Pressure monitors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Reflectometry-IOC.html">Reflectometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Rheometers.html">Rheometers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sample-Changers.html">Sample Changers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Signal-Generators.html">Signal Generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temperature-Controllers.html">Temperature Controllers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Systems.html">Systems Administration &amp; Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Processes &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Providing-Support.html">Providing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Deployment.html">Releases &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Processes.html">Processes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBEX Developer's Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a></li>
          <li class="breadcrumb-item"><a href="../DAE-and-the-ICP.html">DAE (Data Acquisition Electronics)</a></li>
      <li class="breadcrumb-item active">Datastreaming</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_developers_manual/blob/master/doc/specific_iocs/dae/Datastreaming.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="datastreaming">
<h1>Datastreaming<a class="headerlink" href="#datastreaming" title="Link to this heading"></a></h1>
<div class="toctree-wrapper compound">
</div>
<p>The datastreaming system is being built as part of in-kind work to ESS. It will be the system that the ESS uses to take data and write it to file - basically their equivalent to the <a class="reference internal" href="../DAE-and-the-ICP.html"><span class="doc std std-doc">ICP</span></a>. The system may also replace the ICP at ISIS in the future.</p>
<p>In general the system works by passing both neutron and SE data into <a class="reference external" href="https://kafka.apache.org/">Kafka</a> and having clients that either view data live (like Mantid) or write the data to file, additional information can be found <a class="reference external" href="http://accelconf.web.cern.ch/AccelConf/icalepcs2017/papers/tupha029.pdf">here</a> and <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1742-6596/1021/1/012013">here</a>.</p>
<p>All data is passed into flatbuffers using <a class="reference external" href="https://github.com/ess-dmsc/streaming-data-types">these schemas</a> - we have a tool called <a class="reference external" href="https://github.com/ISISComputingGroup/saluki">saluki</a> which can deserialise these and make them human-readable after they’ve been put into Kafka.</p>
<p>The datastreaming layout proposed looks something like this, not including the Mantid steps or anything before event data is collected:</p>
<p><img alt="" src="../../_images/ESSDSLayout.png" /></p>
<section id="datastreaming-at-isis">
<h2>Datastreaming at ISIS<a class="headerlink" href="#datastreaming-at-isis" title="Link to this heading"></a></h2>
<p>Part of our in-kind contribution to datastreaming is to test the system in production at ISIS. Currently it is being tested in the following way, with explanations of each component below:</p>
<p><img alt="" src="../../_images/ISISDSLayout.png" /></p>
</section>
<section id="kafkacluster">
<h2>The Kafka Cluster<a class="headerlink" href="#kafkacluster" title="Link to this heading"></a></h2>
<p>There is a Kafka cluster at <code class="docutils literal notranslate"><span class="pre">livedata.isis.cclrc.ac.uk</span></code>. Port 31092 is used for the primary Kafka broker.
A web interface is available <a class="reference external" href="https://reduce.isis.cclrc.ac.uk/redpanda-console/overview">here</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It was decided that we no longer maintain the Kafka cluster, and it will be handled by the the Flexible Interactive
Automation team. See <code class="docutils literal notranslate"><span class="pre">\\isis\shares\ISIS_Experiment_Controls\On</span> <span class="pre">Call\autoreduction_livedata_support.txt</span></code> for their
support information.</p>
</div>
<section id="i-want-my-own-local-instance-of-kafka">
<h3>I want my own local instance of Kafka<a class="headerlink" href="#i-want-my-own-local-instance-of-kafka" title="Link to this heading"></a></h3>
<p>See <a class="reference internal" href="datastreaming/Datastreaming-How-To.html#localredpanda"><span class="std std-ref">Run my own instance of Kafka/Redpanda</span></a></p>
</section>
</section>
<section id="neutron-data">
<h2>Neutron Data<a class="headerlink" href="#neutron-data" title="Link to this heading"></a></h2>
<p>The ICP on any instrument that is running in full event mode and with a DAE3 may stream neutron events into Kafka.</p>
<p>This is controlled using flags in the <code class="docutils literal notranslate"><span class="pre">isisicp.properties</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span> <span class="o">=</span> <span class="n">true</span>
<span class="c1"># if not specified, topicprefix will default to instrument name in code</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span><span class="o">.</span><span class="n">topicprefix</span> <span class="o">=</span>
<span class="c1"># FIA team run their kafka cluster on port 31092, not 9092</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">livedata</span><span class="o">.</span><span class="n">isis</span><span class="o">.</span><span class="n">cclrc</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">:</span><span class="mi">31092</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">runinfo</span> <span class="o">=</span> <span class="n">_runInfo</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">sampleenv</span> <span class="o">=</span> <span class="n">_sampleEnv</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">kafkastream</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">alarms</span> <span class="o">=</span> <span class="n">_alarms</span>
</pre></div>
</div>
<p>In the same file, you will also need to ensure the following properties are set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">isisicp</span><span class="o">.</span><span class="n">incrementaleventnexus</span> <span class="o">=</span> <span class="n">true</span>

<span class="c1"># Event rate, can adjust up or down</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">neventssim</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Ensure simulated data is switched on</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">simulatedata</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">simulatespec0</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">simulatebin0</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">isisicp</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">spreadsimevents</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>You additionally need to ensure you are running in event mode. You can do this using the DAE tables <code class="docutils literal notranslate"><span class="pre">wiring_event_ibextest.dat</span></code>, <code class="docutils literal notranslate"><span class="pre">detector_ibextest.dat</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">spectra_ibextest.dat</span></code>. Copies of these tables can be found at:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\\<span class="n">isis</span>\<span class="n">shares</span>\<span class="n">ISIS_Experiment_Controls</span>\<span class="n">event_mode_tables</span>
</pre></div>
</div>
</section>
<section id="se-data">
<h2>SE Data<a class="headerlink" href="#se-data" title="Link to this heading"></a></h2>
<p>See <a class="reference internal" href="datastreaming/Datastreaming---Sample-Environment.html"><span class="doc std std-doc">Forwarding Sample Environment</span></a></p>
</section>
<section id="filewriting">
<h2>Filewriting<a class="headerlink" href="#filewriting" title="Link to this heading"></a></h2>
<p>See <a class="reference internal" href="datastreaming/Datastreaming---File-writing.html"><span class="doc std std-doc">File writing</span></a></p>
</section>
<section id="system-tests">
<h2>System Tests<a class="headerlink" href="#system-tests" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These tests are not currently enabled.</p>
</div>
<p>Currently system tests are being run to confirm that the start/stop run and event data messages are being sent into
Kafka and that a Nexus file is being written with these events. The Kafka cluster and filewriter are being run in docker
containers for these tests and so must be run on a Windows 10 machine. To run these tests you will need to
install <a class="reference external" href="https://docs.docker.com/docker-for-windows/install/#install-docker-desktop-on-windows">docker for windows and add yourself as a docker-user</a>.</p>
</section>
<section id="the-future-of-streaming-at-isis">
<h2>The future of streaming at ISIS<a class="headerlink" href="#the-future-of-streaming-at-isis" title="Link to this heading"></a></h2>
<p>After the in-kind work finishes and during the handover, there are some proposed changes that affect the layout and
integration of data streaming at ISIS. This diagram is subject to change, but shows a brief overview of what the future
system might look like:</p>
<p><img alt="" src="../../_images/FUTUREISISDSLayout.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Dae-Spectra-Updating-Problem.html" class="btn btn-neutral float-left" title="Dae Spectra Updating Problem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="datastreaming/Datastreaming---File-writing.html" class="btn btn-neutral float-right" title="File writing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 31, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>