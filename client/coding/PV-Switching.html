

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instrument &amp; PV switching &mdash; IBEX Developer&#39;s Manual</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=e6a88b47" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Perspectives" href="Perspectives.html" />
    <link rel="prev" title="GUI Coding Conventions" href="GUI-Coding-Conventions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBEX Developer's Manual
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Editing-the-Wiki.html">Editing this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Interfaces &amp; Scripting</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../Client.html">IBEX GUI (Eclipse)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../GUI-Building.html">Building</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../GUI-Coding.html">Coding</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Activators.html">Activators</a></li>
<li class="toctree-l3"><a class="reference internal" href="Adding-a-Plugin-or-Feature-to-Maven-Build.html">Adding a plugin or feature</a></li>
<li class="toctree-l3"><a class="reference internal" href="Connecting-a-View-to-a-PV.html">Connecting a view to a PV</a></li>
<li class="toctree-l3"><a class="reference internal" href="Databinding.html">Databinding</a></li>
<li class="toctree-l3"><a class="reference internal" href="GUI-Coding-Conventions.html">GUI Coding Conventions</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Instrument &amp; PV switching</a></li>
<li class="toctree-l3"><a class="reference internal" href="Perspectives.html">Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="Static-analysis.html">Static analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-Testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-Eclipse.html">Eclipse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-CSS.html">CS-Studio Views in the GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-Other.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-Troubleshooting.html">GUI Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GUI-Design.html">Design Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Script-Generator.html">Script Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Scripting.html">Scripting (Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web.html">Web Dashboard &amp; Chat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IBEX Server &amp; Systems</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../System-components.html">Backend System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../IOCs.html">EPICS IOCs &amp; Support Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Specific-IOCs.html">Specific Devices &amp; IOCs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Systems.html">Systems Administration &amp; Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Processes &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Providing-Support.html">Providing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Deployment.html">Releases &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Processes.html">Processes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBEX Developer's Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Client.html">IBEX GUI (Eclipse)</a></li>
          <li class="breadcrumb-item"><a href="../GUI-Coding.html">Coding</a></li>
      <li class="breadcrumb-item active">Instrument &amp; PV switching</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_developers_manual/blob/master/doc/client/coding/PV-Switching.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="instrument-pv-switching">
<h1>Instrument &amp; PV switching<a class="headerlink" href="#instrument-pv-switching" title="Link to this heading"></a></h1>
<p>To create a PV in the GUI which switches instrument, or closes, on instrument switch, use:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ObservableFactory</span><span class="w"> </span><span class="n">closingObsFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObservableFactory</span><span class="p">(</span><span class="n">OnInstrumentSwitch</span><span class="p">.</span><span class="na">CLOSE</span><span class="p">);</span>
<span class="n">ForwardingObservable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pv</span><span class="w"> </span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">closingObsFactory</span><span class="p">.</span><span class="na">getSwitchableObservable</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringChannel</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;A_PV_ADDRESS&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Subscriptions can then be attached to the PV and will be called when PVs change value.</p>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading"></a></h2>
<section id="extension-point">
<h3>Extension point<a class="headerlink" href="#extension-point" title="Link to this heading"></a></h3>
<p>Instrument switching in the GUI uses an extension point. This means that the switch can take place in a central place,
and each plugin which is interested can sign up to receive a callback on the switching event.
This keeps a separation between the plugins and the instrument switching module; a plugin can be removed without
changing the instrument switching code.</p>
<p>The instrument switching in E4 is performed through the E3 compatibility layer, as E4 has no native support for
extension points.
The equivalent behaviour in E4 is provided through services, which might be a necessary transition
as services and extensions points are not cross-compatible.</p>
<p>This extension point is setup in <code class="docutils literal notranslate"><span class="pre">uk.ac.stfc.isis.ibex.instrument/META-INF/MANIFEST.MF</span></code> (see the extension Points tab).
This sets up the name of the extension point and the schema.
The schema is in <code class="docutils literal notranslate"><span class="pre">/uk.ac.stfc.isis.ibex.instrument/schema/uk.ac.stfc.isis.ibex.instrument.info.exsd</span></code>
(click Schema on previous page).
This defines the methods that should be fulfilled by the plugin that want to sign up to this extension.</p>
<p>In this case there are three methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">preSetInstrument</span></code> - this will be called before the instrument is switched. This is useful for closing resources
using the old instrument.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">setInstrument</span></code> - this will be called to set the instrument and should actually perform the change.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">postSetInstrument</span></code> - this will be called after the instrument is set. It can be used, for example, to perform final
clean up of resources or reopening of perspectives.</p></li>
</ul>
<p>The instrument handler is responsible for calling this method on each registered plugin.
It does this in the method
<code class="docutils literal notranslate"><span class="pre">uk.ac.stfc.isis.ibex.instrument.Instrument.setInstrumentForAllPlugins</span></code> in the private method <code class="docutils literal notranslate"><span class="pre">updateExtendingPlugins</span></code>.
All <code class="docutils literal notranslate"><span class="pre">preSetInstruments</span></code> methods are called before any <code class="docutils literal notranslate"><span class="pre">setInstrument</span></code> methods.</p>
<p>To sign up to this event, the plugin must create a class which implements the interface
<code class="docutils literal notranslate"><span class="pre">uk.ac.stfc.isis.ibex.instrument.InstrumentInfoReceiver</span></code>.
This will be instantiated when the instrument is switched to.
This class is registered in the plugin’s extensions (this is similar to
<a class="reference internal" href="Perspectives.html"><span class="doc std std-doc">adding a perspective</span></a>).</p>
</section>
<section id="observables">
<h3>Observables<a class="headerlink" href="#observables" title="Link to this heading"></a></h3>
<p>The design of switchable PVs in the GUI uses a factory to create PV Observables, which are passed the switching
behaviour as a switcher class. Each of these switcher classes provides a different switching functionality and is
switched using the Eclipse extension point that is globally used for instrument switching in the GUI.</p>
<p><img alt="Switching" src="../../_images/new_switching.jpg" /></p>
<ul class="simple">
<li><p>When an observable PV is required an instance of <code class="docutils literal notranslate"><span class="pre">ObservableFactory</span></code> is first created and passed an
<code class="docutils literal notranslate"><span class="pre">OnInstrumentSwitch</span></code> enum to describe which switching behaviour is required</p></li>
<li><p>On initialisation the factory will then query the <code class="docutils literal notranslate"><span class="pre">InstrumentSwitchers</span></code> class for the specific Switcher class that
handles that type of switching.</p></li>
<li><p>The original class that wanted the PV will subsequently ask the factory for PVs, providing the channel type and PV
address. This will be provided as a <code class="docutils literal notranslate"><span class="pre">SwitchableObservable</span></code> that can be subscribed to for value changes.</p></li>
<li><p>Before providing the new <code class="docutils literal notranslate"><span class="pre">Observable</span></code> object the factory will register it with the relevant <code class="docutils literal notranslate"><span class="pre">Switcher</span></code> class, each of
which holds a list of all <code class="docutils literal notranslate"><span class="pre">Switchable</span></code> objects that it is required to switch. The <code class="docutils literal notranslate"><span class="pre">SwitchableObservable</span></code> is also
provided with a reference to the switcher so that it can remove itself from the relevant list if it is closed for any
reason.</p></li>
<li><p>When the instrument is changed the <code class="docutils literal notranslate"><span class="pre">InstrumentSwitchers</span></code> class will call the <code class="docutils literal notranslate"><span class="pre">switchInstruments</span></code> method on each of the
switchers, which will then go on to perform the relevant switching behaviour - for example changing a <code class="docutils literal notranslate"><span class="pre">Switchable</span></code>’s
source, closing it, or doing nothing.</p></li>
</ul>
</section>
<section id="writables">
<h3>Writables<a class="headerlink" href="#writables" title="Link to this heading"></a></h3>
<p>A similar process also occurs when switching writable PVs, as can be seen in the UML diagram below. The differences
being that a <code class="docutils literal notranslate"><span class="pre">WritableFactory</span></code> is used, this can create a <code class="docutils literal notranslate"><span class="pre">Writable</span></code> that inherits from <code class="docutils literal notranslate"><span class="pre">Switchable</span></code> and can write
values to PVs. Both the <code class="docutils literal notranslate"><span class="pre">Switchable</span></code> interface and the abstract <code class="docutils literal notranslate"><span class="pre">PrefixChangingSwitcher</span></code> are provided, so that
the switching process is as similar as possible when dealing with <code class="docutils literal notranslate"><span class="pre">Writables</span></code> and <code class="docutils literal notranslate"><span class="pre">Observables</span></code>.</p>
<p><img alt="Writables" src="../../_images/new_switching_writables.jpg" /></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="GUI-Coding-Conventions.html" class="btn btn-neutral float-left" title="GUI Coding Conventions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Perspectives.html" class="btn btn-neutral float-right" title="Perspectives" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 31, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>