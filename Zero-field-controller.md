> [Wiki](Home) > [The Backend System](The-Backend-System) > [Specific Device IOC](Specific-Device-IOC) > [Other](Other) > [Zero field controller](Zero-field-controller)

This page describes our understanding of the requirements for the MUON zero-field controller.

## Background ##
On a muon instrument, the purpose of the MUON zero-field controller is to maintain a constant (not necessarily zero) magnetic field in the region surrounding the sample.

The magnetic field in the sample region is generated by electromagnets (currently powered by Kepco power supplies). The magnetic field is a vector field, so there are 3 PSUs - one for each component of the magnetic field.  A magnetometer is used to measure the magnetic field (in `mG`) in the sample region.  The magnetometer is connected a cDAQ device (i.e. the cDAQ converts the analog signal from the magnetometer to a digital signal to be read by the control computer).  The magnetometer provides 3 magnetic field readings; one for the longitudinal component, one for the transverse component and one for the vertical component of the magnetic field.  

The zero-field controller operates in one of two modes:
   * Manual
   * Auto-Feedback

#### Manual Mode ####
In Manual mode, the user must adjust the currents manually to achieve the desired magnetic field.  

#### Auto-Feedback Mode ####
In Auto-Feedback mode, the user specifies the desired field (in `mG`) and a feedback loop continually adjusts the current supplied by the PSUs to achieve and maintain the desired magnetic field.  

## Existing MUON zero-field controller ##
All five muon instruments: ARGUS, CHRONUS, EMU, HIFI and MuSR use a zero-field controller, implemented as a collection of LabVIEW VIs.

There appear to be 3 variants of the MUON zero-field controller:
   1. EMU and MuSR both use one variant of the MUON zero-field controller.  This variant can be found in the folder `C:\LabVIEW Modules\Instruments\Muon Magnets`.
   1. ARGUS and CHRONUS both use a second variant of the MUON zero-field controller.  This variant can be found in the folder `C:\LabVIEW Modules\Instruments\ARGUS\Zero Field Controller`.  This variant is similar to the one used by EMU and MuSR.
   1. HIFI has its own unique MUON zero-field controller.  It is not clear where this variant is located.

## Zero-Field Controller Feedback Loop ##
The zero-field controller feedback loop uses the following inputs:
   * **M** – measured magnetic field (it has three components: longitudinal (L), transverse (T) & vertical (V))
   * **O** – Off set (to compensate for sensor placement)
   * _**C**_ – calibration matrix (the inverse the measurements taken in calibrate)
   * **S** – setpoints requested
   * **P** – sensitivity of the coil to current change (is this also measured in calibrate?)
   * p – proportional value (feedback fiddle factor)
   * **I** – current on magnets
   * **I'** - new current to send
Quantities in bold are vector quantities.  Quantities in italic, bold are matrix quantities.

The new current to send is calculated as: <br>
**I'** = (**S** - (**M** - **O**) . _**C**_) . **P** * p + **I**

The following quantities are:
   * **Mc** = (**M** - **O**) . _**C**_ is the corrected field - turns measured field in the basis of the magnetometer into fields produced by the magnet in the basis of the magnets.
   * **Mc** - **S**  is the difference between the current field and required field
   * (**Mc** - **S**) . **P** p  is the change required in the current for this iteration (in current version may need to multiple through by time between samples).

**Notes:**
   1. ARGUS appears to use different magnetic field components, labelled LR, UD and FB.  How do these differ from L, T and V?
   1. The offset value, O, appears to be a constant.  Why is this?
   1. Are there limits on the input & output values?  If so, what are they?  If these limits are breached, what should happen?
   1. Is the above expression guaranteed to converge?  What if it doesn't?  How does the current zero-field controller guard against non-convergence?

## In Operation ##
   * There is a requirement that "Zero field system control needs to be continuous, in the mathematical function sense of not having steps in, when configurations change or control is interrupted.".  How is this requirement currently achieved?
      * it may better to run the zero-field controller on a separate device (e.g. a Raspberry Pi).  This approach would eliminate the risk of interruption should IBEX be halted or the control PC re-booted.
   * Presumably, magnetic fields should not change too rapidly.  Which implies that the currents should not change too rapidly.  Is there maximum (or even minimum) permissible rate of change for the currents?  Is there a maximum permissible change (i.e. step size), positive or negative, in the value of the current?  How frequently should currents be updated?  

## Calibration ##
Need more information on how calibration is performed.  How are the values of the calibration matrix determined?
