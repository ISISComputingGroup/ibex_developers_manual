# Creating LvDCOM IOCBoot areas

Note on LabVIEW rings: EPICS MBBI record items have a maximum length of 25 characters, if a labview ring item name is longer than this it will be either truncated or have spaces removed in the epics display. This will not stop it working, but it is best to keep names within this 25 character limit if at all possible.

## 1 Create ISIS IOC

I plan to make these into a template (so you will just need to run makeBaseApp.pl and not do the edits), but for now this is the manual way

1. Create a public repository to work in called EPICS-<device>.
1. In the `EPICS\ISIS` directory create a directory called <device>
1. Clone the repository into this directory and call that clone master

Create the IOC in master with

```
 makeBaseApp.pl –t ioc <myname>
 makeBaseApp.pl –i –t ioc <myname>
```

Edit `mynameApp/src/build.mak` add dbd file

```
$(APPNAME)_DBD += lvDCOM.dbd
```

and libraries

```
$(APPNAME)_LIBS += lvDCOM 
$(APPNAME)_LIBS += asyn
```

and system library 

```
$(APPNAME)_SYS_LIBS_WIN32 += msxml2
```

## 2 Create the xml configuration file

1. Open the VI in lab view.
1. Export strings from the labview panel (In different version of labview this is different)
     1. 2010:  Go to Tools menu, Advanced, Export Strings... and uncheck the wizard option for "block diagram strings" and save the export results to a text file e.g. controls.txt (Note: you may need write access to the VI itself to do this, so might have to make a local copy of the VI first)
     1. 2014: 
         1. Menu -> Tools -> Advanced -> Export Strings... 
         1. Then save file to (<device>/protocol/controls.txt)
         1. Yes to "Export captions for controls without captions?"
         1. No to "Export block diagram strings?"

1. Generate a corrected xml file. In an epics terminal run in the protocol directory:
```
C:\Instrument\Apps\EPICS\ISIS\lvDCOM\master\lvDCOMApp\src\fix_xml.cmd
"controls.txt" "controls.xml"
```
1. Generate lvcom file:
```
xsltproc C:\Instrument\Apps\EPICS\ISIS\lvDCOM\master\lvDCOMApp\src\lvstrings2input.xsl "controls.xml" > lv_controls.xml
```

1. Edit lv_controls.xml
    1. Do TODOs in file; path in vi needs path to llb containing the vi e.g. `C:/LabVIEW Modules/Drivers/Oxford Instruments/Mercury/Mercury - Temperature.llb/<name of vi>`
    1. remove uneeded controls
1. generate db file
```
xsltproc C:\Instrument\Apps\EPICS\ISIS\lvDCOM\master\lvDCOMApp\src\lvinput2db.xsl lvinput.xml > mercury-front-panel
-1-temp.db
```
1. Copy db file to application Db file
1. Add db file to makefile in

The XML file generated by xsltproc previously should be put into a **mynameApp/protocol** directory and named myname, as well as the .db file being copied into the appropriate mynameApp folder


